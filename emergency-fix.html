<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´§æ€¥ä¿®å¤ - æ–‡ä»¶ä¸Šä¼ æŒ‰é’®</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f8ff;
        }
        .fix-panel {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
        }
        .btn:hover { background: #218838; }
        .btn.danger { background: #dc3545; }
        .btn.danger:hover { background: #c82333; }
        .test-area {
            border: 2px dashed #007bff;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
            cursor: pointer;
        }
        .test-area:hover { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="fix-panel">
        <h1>ğŸš¨ ç´§æ€¥ä¿®å¤ - æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½</h1>
        
        <div id="statusPanel" class="status warning">
            æ­£åœ¨æ£€æµ‹é—®é¢˜...
        </div>

        <div class="test-area" onclick="testDirectUpload()">
            <h3>ğŸ“‚ ç›´æ¥æµ‹è¯•æ–‡ä»¶ä¸Šä¼ </h3>
            <p>ç‚¹å‡»è¿™é‡Œé€‰æ‹©PDFæ–‡ä»¶</p>
            <input type="file" id="directFileInput" accept=".pdf" style="display: none;">
        </div>

        <h3>ğŸ”§ ä¿®å¤é€‰é¡¹</h3>
        <button class="btn" onclick="quickFix()">ğŸš€ ä¸€é”®ä¿®å¤</button>
        <button class="btn" onclick="deepFix()">ğŸ”¨ æ·±åº¦ä¿®å¤</button>
        <button class="btn" onclick="resetAll()">ğŸ”„ é‡ç½®æ‰€æœ‰</button>
        <button class="btn danger" onclick="forceReload()">âš¡ å¼ºåˆ¶é‡è½½</button>

        <div id="logArea" style="background: #000; color: #0f0; padding: 15px; margin-top: 20px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
            ç­‰å¾…æ“ä½œ...<br>
        </div>
    </div>

    <script>
        function log(msg) {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${time}] ${msg}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateStatus(type, message) {
            const panel = document.getElementById('statusPanel');
            panel.className = `status ${type}`;
            panel.innerHTML = message;
        }

        // ç›´æ¥æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
        function testDirectUpload() {
            const fileInput = document.getElementById('directFileInput');
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    log(`âœ… æ–‡ä»¶é€‰æ‹©æˆåŠŸ: ${file.name}`);
                    updateStatus('success', `æ–‡ä»¶å·²é€‰æ‹©: ${file.name}`);
                    
                    // å°è¯•ä¼ é€’ç»™ä¸»çª—å£
                    try {
                        if (window.parent && window.parent.pdfEditor) {
                            window.parent.pdfEditor.handleFileSelect(file);
                            log('âœ… æ–‡ä»¶å·²ä¼ é€’ç»™PDFç¼–è¾‘å™¨');
                            updateStatus('success', 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼PDFç¼–è¾‘å™¨å·²åŠ è½½æ–‡ä»¶ã€‚');
                        } else {
                            log('âš ï¸ æœªæ‰¾åˆ°PDFç¼–è¾‘å™¨å®ä¾‹');
                            updateStatus('warning', 'æ–‡ä»¶é€‰æ‹©æˆåŠŸä½†PDFç¼–è¾‘å™¨æœªå°±ç»ª');
                        }
                    } catch (error) {
                        log(`âŒ ä¼ é€’æ–‡ä»¶å¤±è´¥: ${error.message}`);
                    }
                }
            };
            fileInput.click();
        }

        // ä¸€é”®ä¿®å¤
        function quickFix() {
            log('ğŸš€ å¼€å§‹ä¸€é”®ä¿®å¤...');
            
            try {
                const mainWindow = window.parent;
                const uploadArea = mainWindow.document.getElementById('uploadArea');
                const fileInput = mainWindow.document.getElementById('fileInput');

                if (!uploadArea || !fileInput) {
                    log('âŒ æœªæ‰¾åˆ°ä¸Šä¼ å…ƒç´ ');
                    updateStatus('error', 'æœªæ‰¾åˆ°ä¸Šä¼ å…ƒç´ ï¼Œå°è¯•æ·±åº¦ä¿®å¤');
                    return;
                }

                // ç›´æ¥è®¾ç½®onclickäº‹ä»¶
                uploadArea.onclick = function(e) {
                    log('ğŸ“‚ ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶è§¦å‘');
                    e.preventDefault();
                    fileInput.click();
                };

                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        log(`ğŸ“„ æ–‡ä»¶è¢«é€‰æ‹©: ${file.name}`);
                        if (mainWindow.pdfEditor) {
                            mainWindow.pdfEditor.handleFileSelect(file);
                        }
                    }
                };

                log('âœ… ä¸€é”®ä¿®å¤å®Œæˆ');
                updateStatus('success', 'ä¿®å¤å®Œæˆï¼ç°åœ¨å°è¯•ç‚¹å‡»ä¸»é¡µé¢çš„ä¸Šä¼ æŒ‰é’®');
                
            } catch (error) {
                log(`âŒ ä¸€é”®ä¿®å¤å¤±è´¥: ${error.message}`);
                updateStatus('error', 'ä¸€é”®ä¿®å¤å¤±è´¥ï¼Œè¯·å°è¯•æ·±åº¦ä¿®å¤');
            }
        }

        // æ·±åº¦ä¿®å¤
        function deepFix() {
            log('ğŸ”¨ å¼€å§‹æ·±åº¦ä¿®å¤...');
            
            try {
                const mainWindow = window.parent;
                
                // é‡æ–°åˆ›å»ºä¸Šä¼ åŒºåŸŸçš„HTML
                const uploadArea = mainWindow.document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div class="upload-content">
                            <i class="upload-icon">ğŸ“„</i>
                            <h3>ä¸Šä¼ PDFæ–‡ä»¶ [å·²ä¿®å¤]</h3>
                            <p>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                            <button id="uploadButton" style="margin-top: 10px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">é€‰æ‹©PDFæ–‡ä»¶</button>
                        </div>
                    `;
                    
                    // è·å–æ–°çš„å…ƒç´ 
                    const newFileInput = mainWindow.document.getElementById('fileInput');
                    const uploadButton = mainWindow.document.getElementById('uploadButton');
                    
                    // ç»‘å®šå¤šä¸ªäº‹ä»¶
                    uploadArea.onclick = function() {
                        log('ğŸ“‚ ä¸Šä¼ åŒºåŸŸç‚¹å‡»');
                        newFileInput.click();
                    };
                    
                    uploadButton.onclick = function() {
                        log('ğŸ”˜ ä¸Šä¼ æŒ‰é’®ç‚¹å‡»');
                        newFileInput.click();
                    };
                    
                    newFileInput.onchange = function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            log(`ğŸ“„ æ·±åº¦ä¿®å¤: æ–‡ä»¶è¢«é€‰æ‹© - ${file.name}`);
                            if (mainWindow.pdfEditor) {
                                mainWindow.pdfEditor.handleFileSelect(file);
                            }
                        }
                    };
                    
                    log('âœ… æ·±åº¦ä¿®å¤å®Œæˆ');
                    updateStatus('success', 'æ·±åº¦ä¿®å¤å®Œæˆï¼ä¸Šä¼ åŒºåŸŸå·²é‡æ–°æ„å»º');
                }
                
            } catch (error) {
                log(`âŒ æ·±åº¦ä¿®å¤å¤±è´¥: ${error.message}`);
                updateStatus('error', 'æ·±åº¦ä¿®å¤å¤±è´¥ï¼Œè¯·å°è¯•é‡ç½®');
            }
        }

        // é‡ç½®æ‰€æœ‰
        function resetAll() {
            log('ğŸ”„ é‡ç½®æ‰€æœ‰åŠŸèƒ½...');
            
            try {
                const mainWindow = window.parent;
                
                if (mainWindow.pdfEditor) {
                    // é‡æ–°åˆå§‹åŒ–ç¼–è¾‘å™¨
                    mainWindow.pdfEditor.validateElements();
                    log('âœ… PDFç¼–è¾‘å™¨å·²é‡æ–°éªŒè¯');
                }
                
                // åˆ·æ–°é¡µé¢å…ƒç´ 
                setTimeout(() => {
                    mainWindow.location.reload();
                    log('âœ… é¡µé¢å·²é‡æ–°åŠ è½½');
                }, 1000);
                
                updateStatus('success', 'é‡ç½®å®Œæˆï¼Œé¡µé¢å°†é‡æ–°åŠ è½½');
                
            } catch (error) {
                log(`âŒ é‡ç½®å¤±è´¥: ${error.message}`);
                updateStatus('error', 'é‡ç½®å¤±è´¥');
            }
        }

        // å¼ºåˆ¶é‡è½½
        function forceReload() {
            log('âš¡ æ‰§è¡Œå¼ºåˆ¶é‡è½½...');
            window.parent.location.reload(true);
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æµ‹
        window.onload = function() {
            log('ğŸ” å¼€å§‹è‡ªåŠ¨æ£€æµ‹...');
            
            setTimeout(() => {
                try {
                    const mainWindow = window.parent;
                    const uploadArea = mainWindow.document.getElementById('uploadArea');
                    const fileInput = mainWindow.document.getElementById('fileInput');
                    const pdfEditor = mainWindow.pdfEditor;
                    
                    let issues = 0;
                    
                    if (!uploadArea) { 
                        log('âŒ ä¸Šä¼ åŒºåŸŸæœªæ‰¾åˆ°'); 
                        issues++; 
                    } else { 
                        log('âœ… ä¸Šä¼ åŒºåŸŸå­˜åœ¨'); 
                    }
                    
                    if (!fileInput) { 
                        log('âŒ æ–‡ä»¶è¾“å…¥æœªæ‰¾åˆ°'); 
                        issues++; 
                    } else { 
                        log('âœ… æ–‡ä»¶è¾“å…¥å­˜åœ¨'); 
                    }
                    
                    if (!pdfEditor) { 
                        log('âŒ PDFç¼–è¾‘å™¨å®ä¾‹æœªæ‰¾åˆ°'); 
                        issues++; 
                    } else { 
                        log('âœ… PDFç¼–è¾‘å™¨å®ä¾‹å­˜åœ¨'); 
                    }
                    
                    if (issues === 0) {
                        updateStatus('success', 'æ‰€æœ‰ç»„ä»¶æ­£å¸¸ï¼Œå¯èƒ½æ˜¯äº‹ä»¶ç»‘å®šé—®é¢˜');
                        log('ğŸ’¡ å»ºè®®ï¼šå°è¯•ä¸€é”®ä¿®å¤æ¥é‡æ–°ç»‘å®šäº‹ä»¶');
                    } else {
                        updateStatus('error', `å‘ç° ${issues} ä¸ªé—®é¢˜ï¼Œå»ºè®®è¿›è¡Œæ·±åº¦ä¿®å¤`);
                    }
                    
                } catch (error) {
                    log(`âŒ æ£€æµ‹è¿‡ç¨‹å‡ºé”™: ${error.message}`);
                    updateStatus('error', 'æ£€æµ‹å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¿®å¤');
                }
            }, 500);
        };
    </script>
</body>
</html>