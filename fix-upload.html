<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ ä¿®å¤å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .debug-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .test-upload {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
        }
        .test-upload:hover { border-color: #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>ğŸ”§ PDFç¼–è¾‘å™¨æ–‡ä»¶ä¸Šä¼ ä¿®å¤å·¥å…·</h1>
    
    <div class="debug-section">
        <h3>ğŸ“Š è¯Šæ–­æŠ¥å‘Š</h3>
        <div id="diagnostics">æ£€æŸ¥ä¸­...</div>
    </div>

    <div class="debug-section">
        <h3>ğŸ§ª ä¸Šä¼ åŠŸèƒ½æµ‹è¯•</h3>
        <div class="test-upload" id="testUpload">
            <p>ğŸ“„ ç‚¹å‡»æ­¤å¤„æµ‹è¯•æ–‡ä»¶ä¸Šä¼ </p>
            <input type="file" id="testFileInput" accept=".pdf" style="display: none;">
        </div>
        <div id="testResult" style="margin-top: 10px;"></div>
    </div>

    <div class="debug-section">
        <h3>ğŸ”§ å¿«é€Ÿä¿®å¤</h3>
        <button class="btn" onclick="fixUploadEvents()">ä¿®å¤ä¸Šä¼ äº‹ä»¶</button>
        <button class="btn" onclick="reinitializePDFEditor()">é‡æ–°åˆå§‹åŒ–ç¼–è¾‘å™¨</button>
        <button class="btn" onclick="window.open('/', '_blank')">æ‰“å¼€ä¸»åº”ç”¨</button>
    </div>

    <div class="debug-section">
        <h3>ğŸ“ ä¿®å¤æ—¥å¿—</h3>
        <div id="fixLog" style="height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px;">
            å‡†å¤‡è¿›è¡Œè¯Šæ–­...<br>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('fixLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateDiagnostics(html) {
            document.getElementById('diagnostics').innerHTML = html;
        }

        function runDiagnostics() {
            log('å¼€å§‹è¯Šæ–­æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½...');
            
            const issues = [];
            const fixes = [];

            // æ£€æŸ¥ä¸»çª—å£ä¸­çš„å…ƒç´ 
            const uploadArea = parent.document.getElementById('uploadArea');
            const fileInput = parent.document.getElementById('fileInput');
            const pdfEditor = parent.window.pdfEditor;

            if (!uploadArea) {
                issues.push('âŒ ä¸Šä¼ åŒºåŸŸå…ƒç´ æœªæ‰¾åˆ°');
            } else {
                log('âœ… æ‰¾åˆ°ä¸Šä¼ åŒºåŸŸå…ƒç´ ');
            }

            if (!fileInput) {
                issues.push('âŒ æ–‡ä»¶è¾“å…¥å…ƒç´ æœªæ‰¾åˆ°');  
            } else {
                log('âœ… æ‰¾åˆ°æ–‡ä»¶è¾“å…¥å…ƒç´ ');
            }

            if (!pdfEditor) {
                issues.push('âŒ PDFç¼–è¾‘å™¨å®ä¾‹æœªæ‰¾åˆ°');
            } else {
                log('âœ… æ‰¾åˆ°PDFç¼–è¾‘å™¨å®ä¾‹');
            }

            // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
            const hasClickListener = uploadArea && uploadArea.onclick !== null;
            if (!hasClickListener) {
                issues.push('âŒ ä¸Šä¼ åŒºåŸŸç¼ºå°‘ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨');
                fixes.push('éœ€è¦é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶');
            }

            // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
            let reportHtml = '';
            if (issues.length === 0) {
                reportHtml = '<div class="success">âœ… æ‰€æœ‰ç»„ä»¶æ­£å¸¸</div>';
            } else {
                reportHtml = '<div class="error"><strong>å‘ç°é—®é¢˜:</strong><ul>';
                issues.forEach(issue => reportHtml += `<li>${issue}</li>`);
                reportHtml += '</ul></div>';
                
                if (fixes.length > 0) {
                    reportHtml += '<div><strong>å»ºè®®ä¿®å¤:</strong><ul>';
                    fixes.forEach(fix => reportHtml += `<li>${fix}</li>`);
                    reportHtml += '</ul></div>';
                }
            }

            updateDiagnostics(reportHtml);
            log('è¯Šæ–­å®Œæˆ');
        }

        function fixUploadEvents() {
            log('å°è¯•ä¿®å¤ä¸Šä¼ äº‹ä»¶...');
            
            try {
                const uploadArea = parent.document.getElementById('uploadArea');
                const fileInput = parent.document.getElementById('fileInput');
                const pdfEditor = parent.window.pdfEditor;

                if (uploadArea && fileInput && pdfEditor) {
                    // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                    uploadArea.onclick = null;
                    
                    // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                    uploadArea.addEventListener('click', function() {
                        log('ä¸Šä¼ åŒºåŸŸè¢«ç‚¹å‡»');
                        fileInput.click();
                    });

                    // é‡æ–°ç»‘å®šæ–‡ä»¶é€‰æ‹©äº‹ä»¶
                    fileInput.onchange = function(e) {
                        log('æ–‡ä»¶è¢«é€‰æ‹©: ' + e.target.files[0]?.name);
                        if (e.target.files[0]) {
                            pdfEditor.handleFileSelect(e.target.files[0]);
                        }
                    };

                    log('âœ… ä¸Šä¼ äº‹ä»¶é‡æ–°ç»‘å®šæˆåŠŸ');
                    updateDiagnostics('<div class="success">âœ… ä¸Šä¼ åŠŸèƒ½å·²ä¿®å¤</div>');
                } else {
                    log('âŒ ä¿®å¤å¤±è´¥ï¼šç¼ºå°‘å¿…è¦å…ƒç´ ');
                    updateDiagnostics('<div class="error">âŒ ä¿®å¤å¤±è´¥ï¼šç¼ºå°‘å¿…è¦å…ƒç´ </div>');
                }
            } catch (error) {
                log('âŒ ä¿®å¤è¿‡ç¨‹ä¸­å‡ºé”™: ' + error.message);
                updateDiagnostics('<div class="error">âŒ ä¿®å¤å¤±è´¥: ' + error.message + '</div>');
            }
        }

        function reinitializePDFEditor() {
            log('å°è¯•é‡æ–°åˆå§‹åŒ–PDFç¼–è¾‘å™¨...');
            
            try {
                if (parent.window.pdfEditor) {
                    // é‡æ–°åˆå§‹åŒ–ç¼–è¾‘å™¨
                    parent.window.pdfEditor.setupElements();
                    parent.window.pdfEditor.setupEventListeners();
                    
                    log('âœ… PDFç¼–è¾‘å™¨é‡æ–°åˆå§‹åŒ–æˆåŠŸ');
                    updateDiagnostics('<div class="success">âœ… PDFç¼–è¾‘å™¨å·²é‡æ–°åˆå§‹åŒ–</div>');
                } else {
                    // åˆ›å»ºæ–°å®ä¾‹
                    parent.window.pdfEditor = new parent.PDFEditor();
                    log('âœ… åˆ›å»ºæ–°çš„PDFç¼–è¾‘å™¨å®ä¾‹');
                }
            } catch (error) {
                log('âŒ é‡æ–°åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                updateDiagnostics('<div class="error">âŒ é‡æ–°åˆå§‹åŒ–å¤±è´¥: ' + error.message + '</div>');
            }
        }

        // æµ‹è¯•ä¸Šä¼ åŠŸèƒ½
        document.getElementById('testUpload').addEventListener('click', function() {
            document.getElementById('testFileInput').click();
        });

        document.getElementById('testFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const resultDiv = document.getElementById('testResult');
            
            if (file) {
                log('æµ‹è¯•æ–‡ä»¶é€‰æ‹©æˆåŠŸ: ' + file.name);
                resultDiv.innerHTML = `<div class="success">âœ… æµ‹è¯•æˆåŠŸï¼é€‰æ‹©äº†æ–‡ä»¶: ${file.name}</div>`;
                
                // å°è¯•ä¼ é€’ç»™ä¸»åº”ç”¨
                if (parent.window.pdfEditor) {
                    parent.window.pdfEditor.handleFileSelect(file);
                    log('æ–‡ä»¶å·²ä¼ é€’ç»™PDFç¼–è¾‘å™¨');
                }
            } else {
                resultDiv.innerHTML = '<div class="error">âŒ æœªé€‰æ‹©æ–‡ä»¶</div>';
            }
        });

        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¯Šæ–­
        setTimeout(runDiagnostics, 1000);
    </script>
</body>
</html>